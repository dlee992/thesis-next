\chapter{绪论}\label{introduction}
本章介绍与电子表格缺陷检测相关的研究背景，然后从电子表格缺陷检测的研究现状、研究思路和研究贡献三方面介绍本文工作，最后说明余下章节的组织结构。


\section{研究背景}
\subsection{电子表格的流行}
电子表格已经成为终端用户编程中最流行的范式，在世界范围内被广泛使用。
电子表格的易用性（所见即所得的编程范式）是它如此流行的主要原因之一。
几乎每个使用计算机办公的人都会接触到电子表格应用，例如 Microsoft Excel，Google Sheets 和 Apple Numbers。
众多行业的工作人员，例如精算师，销售人员和行政人员，都是重度依赖电子表格的终端用户\cite{scaffidi2005estimating}，他们经常通过精心编制的电子表格进行数据分析和商业决策。

\subsection{电子表格的使用风险}
然而，终端用户对电子表格的数据可靠性也一直缺乏必要的重视。
电子表格的易用性使得用户不再需要通过专业训练来掌握它的使用方法，而是让用户通过边用边学的方式来掌握它。
因此，很多终端用户并不清楚伴随电子表格而来的使用风险。
这类风险使得电子表格中容易产生数值或公式错误，严重时会导致巨额经济亏损\footnote{http://www.eusprig.org/horror-stories.htm}，例如：

\begin{itemize}
    \item 2012 年，金融投资公司 JP 摩根使用电子表格计算价值-风险模型，其中隐含的电子表格公式方面的使用错误导致决策失效，损失约 40 亿美元；
    \item 2016 年，加拿大电力公司 TransAlta 在电子表格中的复制粘贴不慎引入错误，在与美国签订电力传输保障的合同时，额外支付了约 2,400 万美元。
\end{itemize}

多个实证调研 \cite{panko2016we,powell2009impact} 表明：即使在商业化管控的电子表格环境中，依然缺乏有效的数据可靠性保障技术。
因为终端用户大多不是受过专业训练的程序员，缺乏良好的编程规范，他们更加关心如何把工作里的具体计算或分析任务快速完成。
因此，终端用户的整个编程过程缺少对预期功能和系统的建模、封装和测试等传统的软件质量保障思路和相应的支撑技术。
在现实场景下，多达 90\% 的电子表格都包含一些数值或公式计算上的错误\cite{rajalingham2008classification}，难免造成相关公司的经济损失。


\section{本文工作}
\subsection{研究问题和现状}
电子表格中的错误集中发生在公式计算环节，并暴露在数值单元格和公式单元格中，现有的实证研究\cite{panko2010revising}表明公式单元格中的潜在问题常常是电子表格错误的根源。
在本文中，我们将公式单元格中的错误称为电子表格中的缺陷\footnote{在本文的剩余部分如无特殊说明，电子表格的错误（error）和缺陷（defect）是相同概念，都泛指电子表格中和公式有关的单元格错误，在某些研究工作中也用潜在错误（smell）来指代此类错误}，并且关注于针对这类缺陷进行检测的有效技术。

自动化检测电子表格的缺陷并非易事。
第一，电子表格通常由终端用户维护，维护过程中包含非专业的操作，例如出于各种现实目的，用纯数值改写整个公式或者子公式，在电子表格中埋下有缺陷的单元格。
第二，追踪电子表格的修改历史在电子表格的使用场景下难以实现，因为终端用户并不习惯使用类似 Git 和 SVN 的版本控制软件，这使得我们难以直接诊断出电子表格缺陷是在何时何处引入的。
第三，电子表格单元格之间的计算依赖关系有时是隐晦的，这使得检测电子表格的缺陷变得更为困难。

为了应对这些挑战，研究者们已经提出了各式各样的电子表格缺陷检测技术：

\begin{itemize}
    \item 早期技术依赖于表头信息来推导公式引用中的单位或类型不一致（如\uc \cite{abraham2007ucheck} 和 \di \cite{chambers2009automatic}）；
    \item 目前一类主流技术利用矩形布局的特性来识别丢失公式或者不一致的公式缺陷（如\am \cite{dou2014spreadsheet} 和 \ca \cite{dou2017cacheck}）；
    \item 目前另一类主流技术使用自适应学习的方法来检测跟公式相关的单元格缺陷（如\cu \cite{cheung2016custodes}、Melford\cite{singh2017melford} 和 ExceLint \cite{Barowy2018excelint}）。
\end{itemize}

然而，这些电子表格缺陷检测技术仍有各自的不足之处：

\begin{itemize}
    \item 对第一类来说（基于类型推导的技术），它们的推导相对粗糙，并且关注于非常有限的缺陷种类，导致缺陷检测的精度和召回率都比较低\cite{zhang2017effectively}；
    \item 对第二类来说（基于特定模式或规则匹配的技术），它们倚仗的模式或规则通常是严格且精确的，专注于电子表格中具有某种特性的缺陷类型，因而往往能够获得较高的检测精度（比如\am 的 71.9\% 和 \ca 的 86.8\% \cite{dou2017cacheck}），但无法适应不同电子表格中多变的布局和排版，导致相对有限的召回率（比如\am 的 60.3\% 和 \ca 的 71.0\% \cite{dou2017cacheck}）；
    \item 对第三类来说（基于学习的技术），由于它们先天的自适应学习能力，此类技术得到较为广泛的应用。以 \cu \cite{cheung2016custodes} 为例，因为它被认为是当前“最好的自动化缺陷检测工具”\cite{Barowy2018excelint}。\cu 提取电子表格中的公式特征（强特征）对单元格进行分类，同时通过在电子表格中提取多种单元格的布局特征和隐式计算特征（弱特征），将缺少强特征但含有相似弱特征的单元格吸纳到单元格类中，最后根据公式语法树的差异，识别出类中有缺陷的单元格。该方法极大地提升了检测的召回率（达到 80\% \cite{cheung2016custodes}），但同时把一些无关的单元格也吸纳到类中，进而牺牲了一些检测精度（仅 65\% \cite{cheung2016custodes}）。 
\end{itemize}

\subsection{研究思路}
考虑到上述技术的不足之处，本文提出了一个新颖的技术 \wa \footnote{\wa 的命名方式遵循了 \cu 的风格}，基于 \cu 的自适应的跨表格和跨布局风格的学习能力，同时改善它把不相关的单元格吸纳进单元格类中的不足。
本文的核心观察是：在对单元格进行聚类时，如果偶然地将不相关的单元格混入到类中，必会极大地影响缺陷检测的有效性（例如牺牲检测的精度）。
因此，在 \wa 中本文的主要突破点是关注如何提升电子表格的聚类准确性，通过尽可能地排除那些不相关的单元格使得聚类结果可靠性更高，同时也保留住 \cu 技术的长处。

自下而上地分析，我们认为提升聚类准确性的方法有三层设计思路：
\begin{itemize}
    \item 针对单元格自身的有效性检验：当把数值单元格吸纳进类中时，我们检验它自身是否是有效的。当用一个合适的公式来替换当前数值单元格里的纯数值时，该单元格应该是可有效计算的。否则，如果枚举所有合适的公式后，每一次该单元格都无法有效计算（例如引用一个错误的单元格类型或者使用无效的单元格引用），这个单元格就无法被有效计算得到，应当被阻止吸纳进类中；
    \item 针对单元格之间关系的有效性检验：当把数值单元格吸纳进类中时，它们不应该破坏类中已有单元格之间的共同属性。例如类中已有单元格的引用单元格集合没有交集，如果被吸纳的单元格当它的值被类中某个合适的公式替换后，存在某个单元格和它的引用集合却出现了非空交集，这个单元格就是无效的，应当被阻止吸纳进类中；
    \item 针对整个类的有效性检验：关注整个类层面而不是单个单元格层面的检验。原则上，每个类是用来囊括具有相似计算语义的单元格，那么每个类应该存在一个统一的公式能够符合类中多数单元格的计算语义。如果该类无法满足该属性，即该类具有多种计算语义，它就应该被删除或拆分。
\end{itemize}

% 这里描述比较混乱？
有了这三组自下而上的有效性检验方法，\wa 相较于它的前身 \cu 以及其它电子表格缺陷检测技术，展现出了明显的优势。
在\cu 使用的采样自 EUSES \cite{fisher2005euses} 数据集的 291 个工作表的基准测试集中，\wa 的聚类结果与 \cu 对比，取得了显著的提升，提升了 79.8\% 的工作表的单元格聚类效果，尤其在聚类精度方面取得了 0.3-94.6\% 的提升（平均 20.7\%），在召回率方面仅有 2.4\% 的牺牲。
\wa 通过更加有效的单元格聚类，对比于\cu，使得缺陷检测的精度提升了 23.1\%。
结合召回率来看，最终将 $F\text{-}measure$ 值从 0.71 提升至 0.79。
\wa 也比其它电子表格缺陷检测技术在缺陷检测方面有较大的提升，取得了平均 87.8\% 的精度表现和 71.9\% 的召回率表现，对比于其他技术的 0.5-72.4\% 和 0.1-68.4\%。
另外，我们在一个更大的电子表格数据集 VEnron2 \cite{xu2017spreadcluster} 上进行案例研究，虽然每个缺陷检测技术的检测效果都有大幅下降，但相对而言，\wa 依旧展现出了自身优势，在检测精度方面达到 41.3\%，对比于其它技术的16.3-34.3\%。

\subsection{研究贡献}
结合上述分析，本文的主要贡献有如下三点：
\begin{enumerate}
    \item 我们提出了电子表格缺陷检测技术 \wa ，利用单元格自身、单元格之间关系和整个单元格类的有效性属性来提升 \cu 技术的单元格聚类效果，最终也提升了电子表格缺陷检测的有效性；
    \item 我们使用采样自 EUSES 数据库的电子表格基准测试集和大规模的电子表格语料库 VEnron2 这两个测试对象，与目前主流的其它电子表格缺陷检测技术进行对比，实验结果表明 \wa 技术能够有效地提升聚类和检测的有效性；
    \item 我们实现了两个可视化工具：一个 Excel 插件 EGuard，可在操作 Excel 工作表的同时，看到 \wa 对当前打开的工作表的检测结果和执行信息，使得终端用户能够迅速检查和修复工具报告出的缺陷；另一个集成检测工具 \sg ，可对比多种主流技术的检测结果并统一展示。
\end{enumerate}


\section{组织结构}
本文的剩余章节组织如下：
第2章为相关工作综述，将对和本文相关的工作按照各自类别总结并介绍。
第3章为研究问题的形式化规约，将对本文所研究的问题进行形式化描述。
第4章为系统设计，将对解决本文研究问题所用的方法进行详细介绍。
第5章为系统实现和工具展示，将介绍本文的 \wa 检测方法的实现细节，并对两个可视化工具的使用进行简要说明。
第6章为实验评估，将阐述实验的设计思路和执行配置，并对实验结果进行分析比对，验证该方法的有效性。
第7章总结全文，并从本文的视角指出该方向的研究展望。